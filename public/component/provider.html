<div x-data="{
        showEditModel: false,
        getEmptyProvider() {
            return {
                id: null,
                name: '',
                provider_key: '',
                provider_keys: [],
                models: [],
                custom_fields: [],
                endpoint: '',
                use_proxy: false,
                limit_model: false,
            };
        },
        editingData: {
            id: null,
            name: '',
            provider_key: '',
            provider_keys: [],
            models: [],
            endpoint: '',
            use_proxy: false,
            limit_model: false,
            custom_fields: [],
        },
        async deleteProvider(provider) {
            await request(`/ai/manager/provider/${provider.id}`, {
                method: 'DELETE', headers: { 'Content-Type' : 'application/json' } });
            $store.data.reload_providers();
        },
        async startEditing(provider_id) {
            if (provider_id) {
                const detail = await this.getProviderDetail(provider_id);
                this.editingData.id = provider_id;
                this.editingData.name = detail.provider.name;
                this.editingData.provider_key = detail.provider.provider_key;
                this.editingData.provider_keys = detail.provider_keys.map(key => ({ api_key: key.api_key, description: key.description }));
                this.editingData.models = detail.models.map(model => ({ model_name: model.model_name, real_model_name: model.real_model_name }));
                this.editingData.endpoint = detail.provider.endpoint;
                this.editingData.use_proxy = detail.provider.use_proxy;
                this.editingData.limit_model = detail.provider.limit_model;
                this.editingData.custom_fields = detail.custom_fields.map(field => ({ field_name: field.field_name, field_type: field.field_type || 'unset', field_value: field.field_value, description: field.description }));
        } else {
                this.editingData = this.getEmptyProvider();
            }
            this.showEditModel=true;
        },
        async getProviderDetail(provider_id) {
            const response = await request(`/ai/manager/provider/${provider_id}/detail`, {
                method: 'GET', headers: { 'Content-Type' : 'application/json' } });
            return (await response.json()).data;
        },
        onAddModel() {
            this.editingData.models.push({ model_name: '', real_model_name: ''});
        },
        onAddApiKey() {
           this.editingData.provider_keys.push({ api_key: '', description: '' });
        },
        onAddCustomField() {
           this.editingData.custom_fields.push({ field_name: '', field_value: '', description: '', field_type: 'unset' });
        },
        onRemoveModel(index) {
            this.editingData.models.splice(index, 1);
        },
        onRemoveApiKey(index) {
            this.editingData.provider_keys.splice(index, 1);
        },
        onRemoveCustomField(index) {
            this.editingData.custom_fields.splice(index, 1);
        },
        async commitProvider() {
            if (this.editingData) {
                // Check required fields in models
                for (let i = 0; i < this.editingData.models.length; i++) {
                    if (!this.editingData.models[i].model_name) {
                        alert('模型id 不能为空.');
                        return;
                    }
                }

                // Check required fields in api keys
                for (let i = 0; i < this.editingData.provider_keys.length; i++) {
                    if (!this.editingData.provider_keys[i].api_key) {
                        alert('API Key 不能为空.');
                        return;
                    }
                }

                 // Check required fields in custom fields
                for (let i = 0; i < this.editingData.custom_fields.length; i++) {
                    if (!this.editingData.custom_fields[i].field_name) {
                        alert('字段名 不能为空.');
                        return;
                    }
                }

                await request('/ai/manager/provider/commit',
                    {
                        method: 'POST' ,
                        headers: { 'Content-Type' : 'application/json' },
                        body:   JSON.stringify({
                            provider_key: this.editingData.provider_key,
                            name: this.editingData.name,
                            endpoint: this.editingData.endpoint,
                            provider_keys: this.editingData.provider_keys,
                            models: this.editingData.models,
                            limit_model: false,
                            use_proxy: this.editingData.use_proxy,
                            custom_fields: this.editingData.custom_fields
                    })
                    }
                );
                $store.data.reload_providers();
            };
            this.stopEditing();
        },
        stopEditing() {
            this.editingData = this.getEmptyProvider();
            this.showEditModel=false;
        }
    }">
    <button class="btn btn-primary" @click="startEditing()">添加</button>
    <div class="table-header">
        <span class="table-col">Key</span>
        <span class="table-col">Name</span>
        <span class="table-col">Use Proxy</span>
        <span class="table-col">模型</span>
        <span class="table-col">Api Key</span>
        <span class="table-col">Actions</span>
    </div>
    <template x-for="provider in $store.data.providers">
        <div class="table-row">
            <span class="table-col" x-text="provider.provider_key"></span>
            <span class="table-col" x-text="provider.name"></span>
            <span class="table-col" x-text="provider.use_proxy"></span>
            <div class="table-col"></div>
            <div class="table-col">0</div>
            <div class="table-col">
                <button class="btn btn-primary" @click="startEditing(provider.id)">修改</button>
                <button class="btn btn-danger" @click="deleteProvider(provider)">删除</button>
            </div>
        </div>
    </template>

    <template x-if="showEditModel">
        <div class="model-mask" @click.self="stopEditing">
            <div class="model" :style="{ width: '800px', height: '600px' }">
                <div x-text="editingData ? '编辑渠道' : '新增渠道'" class="model-title"></div>
                <div class="form-item">
                    <span class="form-label">名称</span><input x-model="editingData.name" class="form-input" />
                </div>
                <div class="form-item">
                    <span class="form-label">渠道标识</span><input x-model="editingData.provider_key" class="form-input" />
                </div>
                <div class="form-item">
                    <span class="form-label">地址</span><input x-model="editingData.endpoint" class="form-input" />
                </div>
                <div class="form-item">
                    <span class="form-label">使用代理</span><input type="checkbox" x-model="editingData.use_proxy"
                        class="form-checkbox" />
                </div>

                <div class="section">
                    <div class="section-title">模型</div>
                    <div class="section-header">
                        <span class="col required-field">模型id</span>
                        <span class="col">映射模型id</span>
                    </div>
                    <template x-for="(model, index) in editingData.models" :key="index">
                        <div class="section-row">
                            <input type="text" x-model="model.model_name" class="col form-input" required></input>
                            <input type="text" x-model="model.real_model_name" class="col form-input"></input>
                            <button type="button" @click="onRemoveModel(index)">删除</button>
                        </div>
                    </template>
                    <button class="btn btn-primary" @click="onAddModel">添加模型</button>
                </div>

                <div class="section">
                    <div class="section-title">api key</div>
                    <div class="section-header">
                        <span class="col required-field">API Key</span>
                        <span class="col">描述</span>
                    </div>
                    <template x-for="(key, index) in editingData.provider_keys" :key="index">
                        <div class="section-row">
                            <input type="text" x-model="key.api_key" class="col form-input" required></input>
                            <input type="text" x-model="key.description" class="col form-input"></input>
                            <button type="button" @click="onRemoveApiKey(index)">删除</button>
                        </div>
                    </template>
                    <button class="btn btn-primary" @click="onAddApiKey">添加api key</button>
                </div>

                <div class="section">
                    <div class="section-title">自定义字段</div>
                    <div class="section-header">
                        <span class="col required-field">字段名</span>
                        <span class="col">字段值</span>
                        <span class="col">描述</span>
                        <span class="col">字段类型</span>
                    </div>
                    <template x-for="(field, index) in editingData.custom_fields" :key="index">
                        <div class="section-row">
                            <input type="text" x-model="field.field_name" class="col form-input" required></input>
                            <input type="text" x-model="field.field_value" class="col form-input"></input>
                            <input type="text" x-model="field.description" class="col form-input"></input>
                            <select x-model="field.field_type" class="col form-select">
                                <option value="unset">unset</option>
                                <option value="text">text</option>
                                <option value="integer">integer</option>
                                <option value="float">float</option>
                                <option value="boolean">boolean</option>
                            </select>
                            <button type="button" @click="onRemoveCustomField(index)">删除</button>
                        </div>
                    </template>
                    <button class="btn btn-primary" @click="onAddCustomField">添加自定义字段</button>
                </div>

                <button @click="commitProvider" class="btn btn-primary">保存</button>
            </div>
        </div>
    </template>
    <style>
        .section {
            margin-bottom: 15px;
            padding: 10px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .section-header {
            display: flex;
            margin-bottom: 5px;
        }

        .section-header .col {
            flex: 1;
            font-weight: bold;
        }

        .section-row {
            display: flex;
            margin-bottom: 3px;
        }

        .section-row .col {
            flex: 1;
            margin-right: 5px;
        }

        .section-row .col:last-child {
            margin-right: 0;
        }

        .required-field::after {
            content: "*";
            color: red;
            margin-left: 3px;
        }
    </style>
</div>
